<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>–Ü–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü—ñ—è v1.3.6</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* --- CSS Reset (Minimal) --- */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        html { scroll-behavior: smooth; -webkit-text-size-adjust: 100%; }
        body { min-height: 100vh; line-height: 1.5; }
        input, button, textarea, select { font: inherit; border: none; background: none; color: inherit; }
        button { cursor: pointer; }
        table { border-collapse: collapse; border-spacing: 0; }
        img, picture, video, canvas, svg { display: block; max-width: 100%; }

        /* --- –ó–º—ñ–Ω–Ω—ñ —Ç–∞ –¢–µ–º–∏ (–Ø–∫ —É v1.3.5 / v3.3 Opt) --- */
        :root {
            --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            /* –°–≤—ñ—Ç–ª–∞ —Ç–µ–º–∞ */
            --bg-color: #f9f9f9;
            --secondary-bg-color: #ffffff;
            --text-color: #1c1c1e;
            --secondary-text-color: #8a8a8e;
            --separator-color: #d1d1d6;
            --highlight-color: #007AFF;
            --highlight-hover-color: #005ecf;
            --success-color: #34C759;
            --warning-color: #FF9500;
            --danger-color: #FF3B30;
            --danger-hover-color: #d32f26;
            --button-text-color: #ffffff;
            --input-border-color: #c6c6c8;
            --input-bg-color: #ffffff;
            --input-focus-border: var(--highlight-color);
            --input-focus-shadow: 0 0 0 3px rgba(0, 122, 255, 0.25);
            --card-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
            --tab-inactive-bg: #e5e5ea;
            --radius-main: 10px;
            --radius-controls: 8px;
            --padding-main: 16px;
            --padding-controls: 12px;
            --row-bg-match: rgba(52, 199, 89, 0.1);
            --row-bg-shortage: rgba(255, 59, 48, 0.1);
            --row-bg-surplus: rgba(255, 149, 0, 0.1);
            --row-bg-none: rgba(142, 142, 147, 0.05);
            --row-hover-bg: #e9e9ed;
            --safe-area-top: env(safe-area-inset-top, 0px);
            --safe-area-right: env(safe-area-inset-right, 0px);
            --safe-area-bottom: env(safe-area-inset-bottom, 20px);
            --safe-area-left: env(safe-area-inset-left, 0px);
        }

        body.dark-theme {
            /* –¢–µ–º–Ω–∞ —Ç–µ–º–∞ */
            --bg-color: #000000;
            --secondary-bg-color: #1c1c1e;
            --text-color: #f2f2f7;
            --secondary-text-color: #8d8d92;
            --separator-color: #38383a;
            --highlight-color: #0A84FF;
            --highlight-hover-color: #3b9eff;
            --success-color: #30D158;
            --warning-color: #FF9F0A;
            --danger-color: #FF453A;
            --danger-hover-color: #ff6b60;
            --input-border-color: #3a3a3c;
            --input-bg-color: #1c1c1e;
            --input-focus-border: var(--highlight-color);
            --input-focus-shadow: 0 0 0 3px rgba(10, 132, 255, 0.35);
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            --tab-inactive-bg: #2c2c2e;
            --row-bg-match: rgba(48, 209, 88, 0.15);
            --row-bg-shortage: rgba(255, 69, 58, 0.15);
            --row-bg-surplus: rgba(255, 159, 10, 0.15);
            --row-bg-none: rgba(142, 142, 147, 0.1);
            --row-hover-bg: #2c2c2f;
        }

        /* --- –ë–∞–∑–æ–≤—ñ —Å—Ç–∏–ª—ñ --- */
        body { font-family: var(--font-sans); background-color: var(--bg-color); color: var(--text-color); font-size: 16px; line-height: 1.5; display: flex; flex-direction: column; padding-top: var(--safe-area-top); min-height: 100vh; overscroll-behavior-y: contain; }
        #app { display: flex; flex-direction: column; flex-grow: 1; overflow: hidden; }
        small { font-size: 0.8em; color: var(--secondary-text-color); }

        /* --- Header --- */
        header { background-color: var(--secondary-bg-color); padding: 12px var(--padding-main); padding-left: max(var(--padding-main), var(--safe-area-left)); padding-right: max(var(--padding-main), var(--safe-area-right)); text-align: center; border-bottom: 1px solid var(--separator-color); flex-shrink: 0; position: sticky; top: var(--safe-area-top); z-index: 10; }
        header h1 { font-size: 1.15em; font-weight: 600; color: var(--text-color); }

        /* --- Tab Bar --- */
        .tab-bar { display: flex; background-color: var(--secondary-bg-color); border-top: 1px solid var(--separator-color); padding-bottom: var(--safe-area-bottom); flex-shrink: 0; position: sticky; bottom: 0; z-index: 10; }
        .tab-button { flex: 1; padding: 12px 5px; text-align: center; background: none; font-family: inherit; font-size: 0.85em; color: var(--secondary-text-color); cursor: pointer; transition: color 0.2s ease, background-color 0.2s ease; position: relative; border-top: 3px solid transparent; margin-bottom: -1px; }
        .tab-button.active { color: var(--highlight-color); font-weight: 500; border-top-color: var(--highlight-color); }
        .tab-button:active { background-color: var(--tab-inactive-bg); }
        .tab-button.active::after { display: none; }

        /* --- –ö–æ–Ω—Ç–µ–Ω—Ç –≤–∫–ª–∞–¥–æ–∫ --- */
        .tab-content { display: none; flex-grow: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: var(--padding-main); padding-left: max(var(--padding-main), var(--safe-area-left)); padding-right: max(var(--padding-main), var(--safe-area-right)); opacity: 0; transition: opacity 0.3s ease-in-out; }
        .tab-content.active { display: block; opacity: 1; }
        .tab-content h2 { font-size: 1.5em; font-weight: 600; margin-bottom: var(--padding-main); color: var(--text-color); }

        /* --- –ï–ª–µ–º–µ–Ω—Ç–∏ —Ñ–æ—Ä–º --- */
        .form-section { margin-bottom: var(--padding-main); background-color: var(--secondary-bg-color); border-radius: var(--radius-main); padding: var(--padding-main); box-shadow: var(--card-shadow); transition: box-shadow 0.3s ease; }
        .form-section.pulsate { animation: pulsate 0.5s ease-in-out; }
        @keyframes pulsate { 0% { transform: scale(1); } 50% { transform: scale(1.01); } 100% { transform: scale(1); } }
        label { display: block; font-size: 0.85em; color: var(--secondary-text-color); margin-bottom: 6px; font-weight: 500; }
        input[type="text"], input[type="number"], input[type="search"], select, button { width: 100%; padding: var(--padding-controls); font-size: 1rem; border-radius: var(--radius-controls); border: 1px solid var(--input-border-color); background-color: var(--input-bg-color); color: var(--text-color); font-family: inherit; margin-bottom: var(--padding-main); transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease, transform 0.1s ease; appearance: none; -webkit-appearance: none; -moz-appearance: none; }
        button { background-color: var(--highlight-color); color: var(--button-text-color); border: none; cursor: pointer; font-weight: 500; margin-bottom: 10px; }
        input[type="text"]:focus, input[type="number"]:focus, input[type="search"]:focus, select:focus { border-color: var(--input-focus-border); outline: none; box-shadow: var(--input-focus-shadow); }
        input:disabled, select:disabled, button:disabled { background-color: var(--tab-inactive-bg); color: var(--secondary-text-color); cursor: not-allowed; opacity: 0.7; border-color: var(--input-border-color); box-shadow: none !important; transform: none !important; }
        button:disabled { background-color: var(--separator-color); color: var(--secondary-text-color); }

        /* --- –ö–Ω–æ–ø–∫–∏ –¥—ñ–π —Ç–∞ —ñ–Ω–ø—É—Ç–∏ –∑ –∫–Ω–æ–ø–∫–∞–º–∏ --- */
        .file-input-wrapper { position: relative; overflow: hidden; display: block; width: 100%; margin-bottom: 10px; }
        #file-input { position: absolute; left: 0; top: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
        button:active:not(:disabled) { transform: scale(0.98); }
        #save-button:hover:not(:disabled) { background-color: var(--highlight-hover-color); }
        #clear-button { background-color: var(--danger); }
        #clear-button:hover:not(:disabled) { background-color: var(--danger-hover-color); }

        /* --- –°—Ç–∏–ª—ñ –¥–ª—è —ñ–Ω–ø—É—Ç—É –∑ –∫–Ω–æ–ø–∫–æ—é --- */
        .input-with-button { display: flex; align-items: center; gap: 8px; margin-bottom: var(--padding-main); }
        .input-with-button input { flex-grow: 1; margin-bottom: 0; }
        .input-action-button {
             flex-shrink: 0; width: 44px; height: 44px; /* –§—ñ–∫—Å–æ–≤–∞–Ω–∏–π —Ä–æ–∑–º—ñ—Ä */
             padding: 0; margin-bottom: 0; font-size: 1.6em; line-height: 42px; /* –¶–µ–Ω—Ç—Ä—É–≤–∞–Ω–Ω—è —Å—Ç—Ä—ñ–ª–∫–∏ */
             text-align: center; background-color: var(--highlight-color); color: var(--button-text-color);
             border-radius: var(--radius-controls);
        }
        .input-action-button:disabled { background-color: var(--separator-color); color: var(--secondary-text-color); opacity: 0.7; cursor: not-allowed; }
        .input-action-button:active:not(:disabled) { transform: scale(0.95); }
        /* –ö–æ—Ä–∏–≥—É—î–º–æ –≤—ñ–¥—Å—Ç—É–ø –¥–ª—è small –ø—ñ–¥ —ñ–Ω–ø—É—Ç–æ–º –∑ –∫–Ω–æ–ø–∫–æ—é */
        .form-section .input-with-button + small {
             display: block;
             margin-top: calc(-1 * var(--padding-main) + 8px); /* –ü—ñ–¥–Ω—ñ–º–∞—î–º–æ */
             margin-bottom: var(--padding-main);
         }

        /* Select —Ç–∞ –ü–æ—à—É–∫ */
        .filter-section { margin-bottom: var(--padding-main); display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
        .filter-section label { margin-bottom: 0; flex-shrink: 0; }
        select#filter-select, input#name-search-input { padding: 10px 12px; font-size: 0.95em; margin-bottom: 0; flex-grow: 1; }
        select#filter-select { max-width: 260px; padding-right: 40px; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22%23${encodeURIComponent(getComputedStyle(document.documentElement).getPropertyValue('--secondary-text-color').trim().substring(1))}%22%3E%3Cpath%20fill-rule%3D%22evenodd%22%20d%3D%22M4.22%206.22a.75.75%200%20011.06%200L8%208.94l2.72-2.72a.75.75%200%20111.06%201.06l-3.25%203.25a.75.75%200%2001-1.06%200L4.22%207.28a.75.75%200%20010-1.06z%22%20clip-rule%3D%22evenodd%22%20%2F%3E%3C%2Fsvg%3E'); background-repeat: no-repeat; background-position: right 14px center; background-size: 14px auto; cursor: pointer; }
        select#filter-select:disabled { cursor: not-allowed; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22%23${encodeURIComponent(getComputedStyle(document.documentElement).getPropertyValue('--separator-color').trim().substring(1))}%22%3E%3Cpath%20fill-rule%3D%22evenodd%22%20d%3D%22M4.22%206.22a.75.75%200%20011.06%200L8%208.94l2.72-2.72a.75.75%200%20111.06%201.06l-3.25%203.25a.75.75%200%2001-1.06%200L4.22%207.28a.75.75%200%20010-1.06z%22%20clip-rule%3D%22evenodd%22%20%2F%3E%3C%2Fsvg%3E'); }
        input#name-search-input { max-width: 350px; }
        input[type="search"]::-webkit-search-cancel-button { -webkit-appearance: none; height: 1em; width: 1em; margin-left: .4em; background: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23a0a0a0'><path d='M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z'/></svg>") no-repeat 50% 50%; background-size: contain; opacity: .5; cursor: pointer; }
        input[type="search"]:focus::-webkit-search-cancel-button { opacity: .8; }

        /* --- –ö–∞—Ä—Ç–∫–∞ —Ç–æ–≤–∞—Ä—É --- */
        #item-card { background-color: var(--secondary-bg-color); border-radius: var(--radius-main); padding: var(--padding-main); padding-left: calc(var(--padding-main) + 10px); margin-top: var(--padding-main); box-shadow: var(--card-shadow); position: relative; overflow: hidden; display: none; animation: fadeInItemCard 0.3s ease-out; border: 1px solid var(--separator-color); }
        #item-card::before { content:''; position:absolute; left:0; top:-1px; bottom:-1px; width:6px; background-color: var(--separator-color); transition: background-color 0.3s ease; border-radius: var(--radius-main) 0 0 var(--radius-main); }
        #item-card.visible { display: block; }
        #item-card.status-match::before { background-color: var(--success-color); } #item-card.status-shortage::before { background-color: var(--danger-color); } #item-card.status-surplus::before { background-color: var(--warning-color); }
        #item-card p { margin-bottom: 8px; font-size: 0.95em; line-height: 1.5; word-break: break-word; } #item-card p:last-child { margin-bottom: 0; }
        #item-card p strong { font-weight: 500; color: var(--secondary-text-color); min-width: 90px; display: inline-block; margin-right: 5px; } #item-card p span.value { color: var(--text-color); font-weight: 600; }
        @keyframes fadeInItemCard { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- –ü—Ä–æ–≥—Ä–µ—Å —Ç–∞ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ --- */
        #progress-section { background: none; border: none; box-shadow: none; padding: 0; margin-bottom: var(--padding-main); display: none; }
        #progress-section.visible { display: block; } #progress-section label { font-size: 0.8em; color: var(--secondary-text-color); margin-bottom: 6px; display: block; }
        #progress-bar-container { width: 100%; height: 6px; background-color: var(--separator-color); border-radius: 3px; overflow: hidden; margin-bottom: 10px; }
        #progress-bar { width: 0%; height: 100%; background-color: var(--highlight-color); border-radius: 3px; transition: width 0.5s ease-out; }
        #stats-info { font-size: 0.8em; color: var(--secondary-text-color); display: flex; justify-content: space-around; flex-wrap: wrap; gap: 10px 15px; text-align: center; padding-top: 5px; }
        #stats-info span { white-space: nowrap; } #stats-info .stat-value { font-weight: 600; color: var(--text-color); margin-left: 3px; }
        #stats-info .stat-shortage { color: var(--danger-color); } #stats-info .stat-surplus { color: var(--warning-color); }

        /* --- –¢–∞–±–ª–∏—Ü—ñ --- */
        #items-table-container, #results-table-container { background-color: var(--secondary-bg-color); border-radius: var(--radius-main); box-shadow: var(--card-shadow); border: 1px solid var(--separator-color); padding: 0; margin-top: var(--padding-main); overflow: hidden; overflow-x: auto; }
        #items-table, #results-table { width: 100%; border-collapse: collapse; }
        #items-table th, #items-table td, #results-table th, #results-table td { padding: 10px 14px; text-align: left; border: none; border-bottom: 1px solid var(--separator-color); font-size: 0.85em; font-family: inherit; white-space: nowrap; vertical-align: middle; }
        #items-table th, #results-table th { background-color: transparent; color: var(--secondary-text-color); font-size: 0.8em; font-weight: 500; position: sticky; top: 0; z-index: 5; border-bottom-width: 1px; text-transform: uppercase; letter-spacing: 0.3px; }
        #items-table tbody tr, #results-table tbody tr { transition: background-color 0.15s ease; }
        #items-table tbody tr.status-match, #results-table tbody tr.status-match { background-color: var(--row-bg-match); } #items-table tbody tr.status-shortage, #results-table tbody tr.status-shortage { background-color: var(--row-bg-shortage); } #items-table tbody tr.status-surplus, #results-table tbody tr.status-surplus { background-color: var(--row-bg-surplus); } #items-table tbody tr.status-none { background-color: var(--row-bg-none); }
        @media (hover: hover) { #items-table tbody tr:hover, #results-table tbody tr:hover { background-color: var(--row-hover-bg) !important; } }
        #items-table tbody tr:last-child td, #results-table tbody tr:last-child td { border-bottom: none; }
        #items-table .status-indicator, #results-table .status-indicator { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 8px; vertical-align: middle; }
        #items-table .status-match .status-indicator, #results-table .status-match .status-indicator { background-color: var(--success-color); } #items-table .status-shortage .status-indicator, #results-table .status-shortage .status-indicator { background-color: var(--danger-color); } #items-table .status-surplus .status-indicator, #results-table .status-surplus .status-indicator { background-color: var(--warning-color); } #items-table .status-none .status-indicator { background-color: var(--separator-color); }
        #results-table td:last-child { font-weight: 500; } .status-text-match { color: var(--success-color); } .status-text-shortage { color: var(--danger-color); } .status-text-surplus { color: var(--warning-color); } .status-text-none { color: var(--secondary-text-color); }
        .empty-msg { text-align: center !important; padding: var(--padding-main) !important; color: var(--secondary-text-color) !important; font-style: italic; background-color: transparent !important; }

        /* --- –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è (Toast) --- */
        #toast-notification { bottom: calc(var(--safe-area-bottom) + 70px + var(--padding-main)); background-color: rgba(40, 40, 40, 0.9); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); color: #ffffff; padding: 10px 20px; border-radius: var(--radius-main); font-size: 0.9em; z-index: 1000; opacity: 0; transition: all 0.3s ease; pointer-events: none; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.15); border: 1px solid rgba(255,255,255,0.1); }
        body.dark-theme #toast-notification { background-color: rgba(230, 230, 230, 0.9); color: #1c1c1e; border-color: rgba(0,0,0,0.1); }
        #toast-notification.show { opacity: 1; bottom: calc(var(--safe-area-bottom) + 70px + var(--padding-main) + 5px); }

        /* --- –ö–Ω–æ–ø–∫–∞ —Ç–µ–º–∏ --- */
        #theme-toggle-button { position: fixed; bottom: calc(var(--padding-main) + var(--safe-area-bottom)); right: calc(var(--padding-main) + var(--safe-area-right)); z-index: 100; width: 46px; height: 46px; border-radius: 50%; background-color: var(--secondary-bg-color); color: var(--secondary-text-color); border: 1px solid var(--separator-color); box-shadow: var(--card-shadow); cursor: pointer; display: flex; justify-content: center; align-items: center; padding: 0; margin: 0; transition: all 0.2s ease; }
        #theme-toggle-button:hover { border-color: var(--highlight-color); color: var(--highlight-color); transform: translateY(-1px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        body.dark-theme #theme-toggle-button:hover { box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        #theme-toggle-button:active { transform: scale(0.95); }
        #theme-toggle-button svg { width: 22px; height: 22px; stroke-width: 1.8; }
        .theme-icon-sun { display: none; } .theme-icon-moon { display: block; }
        body.dark-theme #theme-toggle-button .theme-icon-sun { display: block; }
        body.dark-theme #theme-toggle-button .theme-icon-moon { display: none; }

    </style>
</head>
<body>
    <div id="app">
        <header>
            <h1>–Ü–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü—ñ—è v1.3.6</h1> </header>

        <main class="tab-content active" id="inventory-tab">
            <div class="form-section">
                <label for="sku-input">–ê—Ä—Ç–∏–∫—É–ª —Ç–æ–≤–∞—Ä—É</label>
                <div class="input-with-button">
                    <input type="text" id="sku-input" placeholder="–°–∫–∞–Ω—É–π—Ç–µ –∞–±–æ –≤–≤–µ–¥—ñ—Ç—å –∞—Ä—Ç–∏–∫—É–ª">
                    <button type="button" id="sku-submit-button" class="input-action-button" aria-label="–ó–Ω–∞–π—Ç–∏/–°—Ç–≤–æ—Ä–∏—Ç–∏ –∞—Ä—Ç–∏–∫—É–ª">‚ûú</button>
                </div>

                <label for="quantity-input">–ó–º—ñ–Ω–∞ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ</label>
                 <div class="input-with-button">
                    <input type="text" inputmode="numeric" id="quantity-input" placeholder="–ß–∏—Å–ª–æ(+) –∞–±–æ 0+–ß–∏—Å–ª–æ(-)" disabled>
                    <button type="button" id="quantity-submit-button" class="input-action-button" aria-label="–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å" disabled>‚ûú</button>
                 </div>
                 <small>–î–æ–¥–∞—Ç–∏: –ß–∏—Å–ª–æ. –í—ñ–¥–Ω—è—Ç–∏: 0+–ß–∏—Å–ª–æ.</small>
            </div>
             <div id="item-card">
                 <p><strong>–ù–∞–∑–≤–∞:</strong> <span id="item-name" class="value">-</span></p>
                 <p><strong>–ê—Ä—Ç–∏–∫—É–ª:</strong> <span id="item-sku" class="value">-</span></p>
                 <p><strong>–û—á—ñ–∫—É–≤–∞–Ω–æ:</strong> <span id="item-expected" class="value">-</span></p>
                 <p><strong>–§–∞–∫—Ç–∏—á–Ω–æ:</strong> <span id="item-actual" class="value">-</span></p>
                 <p><strong>–°—Ç–∞—Ç—É—Å:</strong> <span id="item-status">-</span></p>
             </div>
            <div class="file-input-wrapper" style="margin-top: var(--padding-main);">
                <button class="file-input-button" type="button" id="upload-button">–í—ñ–¥–∫—Ä–∏—Ç–∏ —Ñ–∞–π–ª</button>
                <input type="file" id="file-input" accept=".xlsx, .xls">
            </div>
            <button id="save-button" disabled>–ó–±–µ—Ä–µ–≥—Ç–∏ —ñ–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü—ñ—é</button>
            <button id="clear-button" class="danger" disabled>–û—á–∏—Å—Ç–∏—Ç–∏ –¥–∞–Ω—ñ</button>
        </main>

        <main class="tab-content" id="items-tab">
             <h2>–°–ø–∏—Å–æ–∫ –¢–æ–≤–∞—Ä—ñ–≤</h2>
            <p id="file-info" style="font-size: 0.9em; color: var(--secondary-text-color); margin-bottom: var(--padding-main);">–§–∞–π–ª –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ.</p>
            <div id="progress-section">
                 <label>–ü—Ä–æ–≥—Ä–µ—Å</label>
                 <div id="progress-bar-container"><div id="progress-bar"></div></div>
                 <div id="stats-info">
                    <span id="stat-total">–í—Å: <span class="stat-value">0</span></span>
                    <span id="stat-checked">–ü–µ—Ä: <span class="stat-value">0</span></span>
                    <span id="stat-match">Ok: <span class="stat-value">0</span></span>
                    <span id="stat-shortage">–ù–µ—Å—Ç: <span class="stat-value stat-shortage">0</span></span>
                    <span id="stat-surplus">–ù–∞–¥–ª: <span class="stat-value stat-surplus">0</span></span>
                 </div>
            </div>
            <div class="filter-section">
                 <label for="filter-select">–§—ñ–ª—å—Ç—Ä:</label>
                 <select id="filter-select">
                     <option value="all">–í—Å—ñ —Ç–æ–≤–∞—Ä–∏</option>
                     <option value="match">‚úÖ –í—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ—Å—Ç—å</option>
                     <option value="shortage">üîª –ù–µ—Å—Ç–∞—á–∞</option>
                     <option value="surplus">üî∂ –ù–∞–¥–ª–∏—à–æ–∫</option>
                     <option value="unchecked">‚ö™ –ù–µ –ø–µ—Ä–µ–≤—ñ—Ä–µ–Ω–æ</option>
                 </select>
                 <label for="name-search-input" style="margin-left: 10px;">–ü–æ—à—É–∫:</label>
                 <input type="search" id="name-search-input" placeholder="–ù–∞–∑–≤–∞ —Ç–æ–≤–∞—Ä—É...">
            </div>
            <div id="items-table-container">
                <table id="items-table">
                    <thead><tr><th>–°—Ç–∞—Ç—É—Å</th><th>–ê—Ä—Ç–∏–∫—É–ª</th><th>–ù–∞–∑–≤–∞</th><th>–û—á—ñ–∫.</th><th>–§–∞–∫—Ç.</th></tr></thead>
                    <tbody id="items-table-body"><tr class="empty-msg"><td colspan="5">–ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Ñ–∞–π–ª.</td></tr></tbody>
                </table>
            </div>
        </main>

        <main class="tab-content" id="result-tab">
             <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç–∏</h2>
            <p id="result-info" style="font-size: 0.9em; color: var(--secondary-text-color); margin-bottom: var(--padding-main);">–°–ø–∏—Å–æ–∫ —Ä–æ–∑–±—ñ–∂–Ω–æ—Å—Ç–µ–π.</p>
            <div id="results-table-container">
                <table id="results-table">
                    <thead><tr><th>–°—Ç–∞—Ç—É—Å</th><th>–ê—Ä—Ç–∏–∫—É–ª</th><th>–ù–∞–∑–≤–∞</th><th>–û—á—ñ–∫.</th><th>–§–∞–∫—Ç.</th><th>–†—ñ–∑–Ω–∏—Ü—è</th></tr></thead>
                    <tbody id="results-table-body"><tr class="empty-msg"><td colspan="6">–†–æ–∑–±—ñ–∂–Ω–æ—Å—Ç—ñ –≤—ñ–¥—Å—É—Ç–Ω—ñ.</td></tr></tbody>
                </table>
            </div>
        </main>

        <nav class="tab-bar">
            <button class="tab-button active" data-tab="inventory-tab">–°–∫–∞–Ω—É–≤–∞–Ω–Ω—è</button>
            <button class="tab-button" data-tab="items-tab">–°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä—ñ–≤</button>
            <button class="tab-button" data-tab="result-tab">–†–µ–∑—É–ª—å—Ç–∞—Ç–∏</button>
        </nav>

        <div id="toast-notification"></div>

    </div><button id="theme-toggle-button" aria-label="–ó–º—ñ–Ω–∏—Ç–∏ —Ç–µ–º—É">
         <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" class="theme-icon theme-icon-moon"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
         <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" class="theme-icon theme-icon-sun"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
    </button>

    <script>
        // --- –ì–ª–æ–±–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ, –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∏ ---
        let items = []; let currentItem = null; let lastDisplayedItem = null; let fileMetadata = { originalName: null, loadDate: null }; let currentFilter = 'all'; let db = null;
        const DB_NAME = 'inventoryDB'; const DB_VERSION = 1; const ITEMS_STORE_NAME = 'items'; const META_STORE_NAME = 'metadata'; const META_KEY = 'sessionInfo';
        const STATUS_MAP = { MATCH: '–í—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ—Å—Ç—å', SHORTAGE: '–ù–µ—Å—Ç–∞—á–∞', SURPLUS: '–ù–∞–¥–ª–∏—à–æ–∫', NONE: '–ù–µ –ø–µ—Ä–µ–≤—ñ—Ä–µ–Ω–æ' }; const STATUS_CLASS_MAP = { [STATUS_MAP.MATCH]: 'status-match', [STATUS_MAP.SHORTAGE]: 'status-shortage', [STATUS_MAP.SURPLUS]: 'status-surplus', [STATUS_MAP.NONE]: 'status-none' }; const STATUS_TEXT_CLASS_MAP = { [STATUS_MAP.MATCH]: 'status-text-match', [STATUS_MAP.SHORTAGE]: 'status-text-shortage', [STATUS_MAP.SURPLUS]: 'status-text-surplus', [STATUS_MAP.NONE]: 'status-text-none' };

        // --- DOM –ï–ª–µ–º–µ–Ω—Ç–∏ ---
        const uploadButton = document.getElementById('upload-button'); const fileInput = document.getElementById('file-input'); const skuInput = document.getElementById('sku-input'); const quantityInput = document.getElementById('quantity-input'); const itemCard = document.getElementById('item-card'); const itemNameEl = document.getElementById('item-name'); const itemSkuEl = document.getElementById('item-sku'); const itemExpectedEl = document.getElementById('item-expected'); const itemActualEl = document.getElementById('item-actual'); const itemStatusEl = document.getElementById('item-status'); const saveButton = document.getElementById('save-button'); const clearButton = document.getElementById('clear-button'); const progressBar = document.getElementById('progress-bar'); const progressSection = document.getElementById('progress-section'); const itemsTableBody = document.getElementById('items-table-body'); const filterSelect = document.getElementById('filter-select'); const nameSearchInput = document.getElementById('name-search-input'); const resultsTableBody = document.getElementById('results-table-body'); const fileInfoEl = document.getElementById('file-info'); const tabButtons = document.querySelectorAll('.tab-button'); const tabContents = document.querySelectorAll('.tab-content'); const toastNotification = document.getElementById('toast-notification'); const themeToggleButton = document.getElementById('theme-toggle-button');
        // –î–û–î–ê–ù–û: –ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –Ω–æ–≤—ñ –∫–Ω–æ–ø–∫–∏
        const skuSubmitButton = document.getElementById('sku-submit-button');
        const quantitySubmitButton = document.getElementById('quantity-submit-button');

        // --- IndexedDB –§—É–Ω–∫—Ü—ñ—ó (–±–µ–∑ –∑–º—ñ–Ω) ---
        function openDB() { return new Promise((resolve, reject) => { try { if (!window.indexedDB) { return reject("No IndexedDB support"); } const request = indexedDB.open(DB_NAME, DB_VERSION); request.onerror = (e) => reject(`DB Error: ${e.target?.error?.message}`); request.onsuccess = (e) => { if (!e.target?.result) return reject("DB open null result"); db = e.target.result; console.log("DB opened"); resolve(db); }; request.onupgradeneeded = (e) => { console.log("onupgradeneeded"); if (!e.target?.result) return; db = e.target.result; try { if (!db.objectStoreNames.contains(ITEMS_STORE_NAME)) { const s = db.createObjectStore(ITEMS_STORE_NAME, { keyPath: 'sku' }); s.createIndex('name', 'name'); s.createIndex('status', 'status'); } if (!db.objectStoreNames.contains(META_STORE_NAME)) { db.createObjectStore(META_STORE_NAME, { keyPath: 'id' }); } } catch (err) { console.error("Store creation error:", err); } console.log("DB upgrade done."); }; request.onblocked = () => reject("DB blocked"); } catch (e) { reject(`openDB exception: ${e}`); } }); }
        function saveItemToDB(item) { return new Promise((resolve, reject) => { if (!db) return reject("DB missing"); if (!item?.sku) return reject("Bad item"); try { const tx = db.transaction([ITEMS_STORE_NAME], 'readwrite'); tx.objectStore(ITEMS_STORE_NAME).put(item).onerror = (e) => reject(`Write Err: ${e.target?.error?.message}`); tx.oncomplete = resolve; tx.onerror = (e) => reject(`Tx Err: ${e.target?.error?.message}`); } catch (e) { reject(`Save Ex: ${e}`); } }); }
        function saveMetadataToDB(metadata) { return new Promise((resolve, reject) => { if (!db) return reject("DB missing"); try { const tx = db.transaction([META_STORE_NAME], 'readwrite'); tx.objectStore(META_STORE_NAME).put({ ...metadata, id: META_KEY }).onerror = (e) => reject(`Meta Write Err: ${e.target?.error?.message}`); tx.oncomplete = resolve; tx.onerror = (e) => reject(`Meta Tx Err: ${e.target?.error?.message}`); } catch(e) { reject(`SaveMeta Ex: ${e}`); } }); }
        function getAllItemsFromDB() { return new Promise((resolve, reject) => { if (!db) return reject("DB missing"); try { const tx = db.transaction([ITEMS_STORE_NAME], 'readonly'); const r = tx.objectStore(ITEMS_STORE_NAME).getAll(); r.onsuccess = (e) => resolve(e.target?.result || []); r.onerror = (e) => reject(`Read Err: ${e.target?.error?.message}`); tx.onerror = (e) => reject(`Read Tx Err: ${e.target?.error?.message}`); } catch (e) { reject(`GetAll Ex: ${e}`); } }); }
        function getMetadataFromDB() { return new Promise((resolve, reject) => { if (!db) return reject("DB missing"); try { const tx = db.transaction([META_STORE_NAME], 'readonly'); const r = tx.objectStore(META_STORE_NAME).get(META_KEY); r.onsuccess = (e) => resolve(e.target?.result || null); r.onerror = (e) => reject(`Meta Read Err: ${e.target?.error?.message}`); tx.onerror = (e) => reject(`Meta Read Tx Err: ${e.target?.error?.message}`); } catch (e) { reject(`GetMeta Ex: ${e}`); } }); }
        function clearItemsDB() { return new Promise((resolve, reject) => { if (!db) return reject("DB missing"); try { const tx = db.transaction([ITEMS_STORE_NAME], 'readwrite'); tx.objectStore(ITEMS_STORE_NAME).clear().onerror = (e) => reject(`Clear Err: ${e.target?.error?.message}`); tx.oncomplete = resolve; tx.onerror = (e) => reject(`Clear Tx Err: ${e.target?.error?.message}`); } catch (e) { reject(`Clear Ex: ${e}`); } }); }
        function clearMetadataDB() { return new Promise((resolve, reject) => { if (!db) return reject("DB missing"); try { const tx = db.transaction([META_STORE_NAME], 'readwrite'); tx.objectStore(META_STORE_NAME).clear().onerror = (e) => reject(`Meta Clear Err: ${e.target?.error?.message}`); tx.oncomplete = resolve; tx.onerror = (e) => reject(`Meta Clear Tx Err: ${e.target?.error?.message}`); } catch (e) { reject(`ClearMeta Ex: ${e}`); } }); }
        async function saveAllItemsToDB(itemsToSave) { if (!db) throw new Error("DB missing for saveAll"); return new Promise((resolve, reject) => { try { const tx = db.transaction([ITEMS_STORE_NAME], 'readwrite'); const store = tx.objectStore(ITEMS_STORE_NAME); itemsToSave.forEach(item => { try { if (item?.sku) store.put(item); } catch (putErr) { console.warn(`Put error for ${item?.sku}:`, putErr); } }); tx.oncomplete = resolve; tx.onerror = (e) => reject(e.target?.error); } catch (e) { reject(e); } }); }

        // --- –õ–æ–≥—ñ–∫–∞ —Ä–æ–±–æ—Ç–∏ –∑ —Ñ–∞–π–ª–∞–º–∏ ---
        function handleFile(event) { const file = event.target?.files?.[0]; if (!file) return; if (items.length > 0 && !confirm("–ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç–∏ –¥–∞–Ω—ñ?")) { if(fileInput) fileInput.value = ''; return; } const reader = new FileReader(); reader.onload = async (e) => { const data = e.target?.result; if (!data) { showToast("–ü–æ–º–∏–ª–∫–∞ —á–∏—Ç–∞–Ω–Ω—è.", 'error'); return; } try { const workbook = XLSX.read(data, { type:'array'}); if (!workbook.SheetNames?.length) throw new Error("–ù–µ–º–∞—î –∞—Ä–∫—É—à—ñ–≤."); const sheet = workbook.Sheets[workbook.SheetNames[0]]; if (!sheet) throw new Error("–ê—Ä–∫—É—à –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ."); const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "", raw: false }); await processFileData(jsonData, file.name); } catch (error) { console.error("–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏:", error); showToast(`–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏: ${error.message || error}`, 'error', 5000); if(fileInput) fileInput.value = ''; } }; reader.onerror = (e) => { console.error("FileReader error:", e); showToast("–ù–µ –≤–¥–∞–ª–æ—Å—è –ø—Ä–æ—á–∏—Ç–∞—Ç–∏ —Ñ–∞–π–ª.", 'error', 5000); if(fileInput) fileInput.value = ''; }; reader.readAsArrayBuffer(file); }
        async function processFileData(jsonData, fileName) { if (!jsonData || jsonData.length < 1) throw new Error("–§–∞–π–ª –ø–æ—Ä–æ–∂–Ω—ñ–π."); const header = jsonData[0].map(h => String(h ?? '').trim().toLowerCase()); if (jsonData.length < 2) throw new Error("–§–∞–π–ª –±–µ–∑ –¥–∞–Ω–∏—Ö."); const dataRows = jsonData.slice(1); const isRes = header.includes('—Ñ–∞–∫—Ç–∏—á–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å') && header.includes('—Å—Ç–∞—Ç—É—Å'); const isNew = header.includes('–∞—Ä—Ç–∏–∫—É–ª') && header.includes('–Ω–∞–∑–≤–∞') && header.includes('–æ—á—ñ–∫—É–≤–∞–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å'); let parsed = []; if (isRes) { const I={sku:header.indexOf('–∞—Ä—Ç–∏–∫—É–ª'), name:header.indexOf('–Ω–∞–∑–≤–∞'), exp:header.indexOf('–æ—á—ñ–∫—É–≤–∞–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å'), act:header.indexOf('—Ñ–∞–∫—Ç–∏—á–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å'), stat:header.indexOf('—Å—Ç–∞—Ç—É—Å')}; if(Object.values(I).includes(-1)){const m=['–∞—Ä—Ç','–Ω–∞–∑–≤–∞','–æ—á—ñ–∫','—Ñ–∞–∫—Ç','—Å—Ç–∞—Ç—É—Å'].filter((h,i)=>!header.includes(Object.keys(I)[i])); throw new Error(`–í—ñ–¥—Å—É—Ç–Ω—ñ(Res): ${m.join(',')}`);} parsed=dataRows.map((r)=>{if(!Array.isArray(r)||r.length<=Math.max(...Object.values(I)))return null;const sku=r[I.sku]?String(r[I.sku]).trim():null;if(!sku)return null;const eQ=parseInt(r[I.exp],10);const aS=r[I.act];const aQ=(aS===''||aS==null)?null:parseInt(aS,10);return {sku,name:String(r[I.name]||''),expectedQuantity:isNaN(eQ)?0:eQ,actualQuantity:(aQ===null||isNaN(aQ))?null:aQ,status:String(r[I.stat]||STATUS_MAP.NONE)};}).filter(i=>i); } else if (isNew) { const I = {sku:header.indexOf('–∞—Ä—Ç–∏–∫—É–ª'), name:header.indexOf('–Ω–∞–∑–≤–∞'), exp:header.indexOf('–æ—á—ñ–∫—É–≤–∞–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å')}; if(Object.values(I).includes(-1)){const m=['–∞—Ä—Ç','–Ω–∞–∑–≤–∞','–æ—á—ñ–∫'].filter((h,i)=>!header.includes(Object.keys(I)[i])); throw new Error(`–í—ñ–¥—Å—É—Ç–Ω—ñ(New): ${m.join(',')}`);} parsed=dataRows.map((r)=>{if(!Array.isArray(r)||r.length<=Math.max(...Object.values(I))) return null;const sku=r[I.sku]?String(r[I.sku]).trim():null;if(!sku)return null;const eQ=parseInt(r[I.exp],10);return {sku,name:String(r[I.name]||''),expectedQuantity:isNaN(eQ)?0:eQ,actualQuantity:null,status:STATUS_MAP.NONE};}).filter(i=>i); } else { throw new Error("–ù–µ–≤—ñ–¥–æ–º–∏–π —Ç–∏–ø —Ñ–∞–π–ª—É."); } if (parsed.length === 0) throw new Error("–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∫–æ—Ä–µ–∫—Ç–Ω–∏—Ö —Ç–æ–≤–∞—Ä—ñ–≤."); try { await clearItemsDB(); await clearMetadataDB(); items=parsed; fileMetadata={originalName:fileName,loadDate:new Date()}; await saveAllItemsToDB(items); await saveMetadataToDB(fileMetadata); lastDisplayedItem=null; currentItem=null; updateUI(); switchToTab('inventory-tab'); if(skuInput)skuInput.focus(); showToast(`"${fileName}" –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ (${items.length}).`, "success"); vibrateBasic(); if(fileInput)fileInput.value=''; } catch (dbErr) { console.error("–ü–æ–º–∏–ª–∫–∞ –ë–î:", dbErr); showToast(`–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è: ${dbErr}`, 'error'); items=[]; fileMetadata={originalName:null,loadDate:null}; updateUI(); } }
        function generateFileName() { const n=new Date();const dF=new Intl.DateTimeFormat('uk',{year:'numeric',month:'2-digit',day:'2-digit'});const tF=new Intl.DateTimeFormat('uk',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false});const d=dF.format(n).replace(/\./g,'');const t=tF.format(n).replace(/:/g,'');const b=fileMetadata.originalName?.replace(/\.(xlsx|xls)$/i,'')||'inv';const s=b.replace(/[^a-z0-9_\-\u0400-\u04FF]/gi,'_').substring(0,30); return `Invent_${s}_${d}_${t}.xlsx`; }
        function saveResultsToFile() { if(items.length===0){showToast("–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö.","warning");return}try{const d=items.map(i=>({'–ê—Ä—Ç–∏–∫—É–ª':i.sku,'–ù–∞–∑–≤–∞':i.name,'–û—á—ñ–∫—É–≤–∞–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å':i.expectedQuantity,'–§–∞–∫—Ç–∏—á–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å':i.actualQuantity??'','–°—Ç–∞—Ç—É—Å':i.status})); const s=XLSX.utils.json_to_sheet(d);const st=calculateStats();const m=[{–ö:'–§–∞–π–ª',–ó:fileMetadata.originalName||'-'},{–ö:'–ó–∞–≤',–ó:fileMetadata.loadDate?.toLocaleString('uk',{dateStyle:'short',timeStyle:'short'})||'-'},{–ö:'–ó–±–µ—Ä',–ó:new Date().toLocaleString('uk',{dateStyle:'short',timeStyle:'short'})},{–ö:'–í—Å',–ó:st.total},{–ö:'–ü–µ—Ä',–ó:st.checked},{–ö:'Ok',–ó:st.match},{–ö:'–ù–µ—Å—Ç',–ó:st.shortage},{–ö:'–ù–∞–¥–ª',–ó:st.surplus}];const ms=XLSX.utils.json_to_sheet(m,{skipHeader:true});const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,s,'–†–µ–∑—É–ª—å—Ç–∞—Ç–∏');XLSX.utils.book_append_sheet(wb,ms,'_metadata');const fN=generateFileName();XLSX.writeFile(wb,fN);showToast('–ó–±–µ—Ä–µ–∂–µ–Ω–æ –≤ "–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è".','success',4000);vibrateBasic()}catch(e){console.error("–ü–æ–º–∏–ª–∫–∞ Excel:",e);showToast(`–ü–æ–º–∏–ª–∫–∞:${e.message}`,'error');}}

        // --- –õ–æ–≥—ñ–∫–∞ —ñ–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü—ñ—ó ---
        function findItemBySku(sku) { if(!sku)return null; const s=sku.trim().toLowerCase(); return items.find(i=>String(i.sku).toLowerCase()===s); }
        // –ó–ú–Ü–ù–ï–ù–û: –î–æ–¥–∞–Ω–æ async, –ª–æ–≥—ñ–∫—É confirm/prompt/create
        async function handleSkuInput() {
            const skuVal=skuInput?.value; if(skuVal==null)return; const sku=skuVal.trim(); const found=findItemBySku(sku); currentItem=null;
            if(found){
                lastDisplayedItem={...found}; displayItemCard(lastDisplayedItem);
                if(quantityInput){ quantityInput.disabled = false; quantityInput.value = ''; quantityInput.placeholder = `–ü–æ—Ç:${found.actualQuantity??0}. –î–æ–¥–∞—Ç–∏? 0-–í—ñ–¥–Ω—è—Ç–∏?`; }
                if(quantitySubmitButton) quantitySubmitButton.disabled = false; // –í–º–∏–∫–∞—î–º–æ –∫–Ω–æ–ø–∫—É
                console.log("Focusing quantity (existing item)"); if(quantityInput) quantityInput.focus(); // –§–æ–∫—É—Å –Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å
                if(itemCard){ itemCard.classList.add('pulsate'); setTimeout(()=>itemCard?.classList.remove('pulsate'), 500); }
                currentItem = found;
            } else if (sku !== '') {
                clearItemCard(); lastDisplayedItem = null;
                if(quantityInput) quantityInput.disabled = true;
                if(quantitySubmitButton) quantitySubmitButton.disabled = true; // –í–∏–º–∏–∫–∞—î–º–æ –∫–Ω–æ–ø–∫—É –∫-—Å—Ç—ñ

                if(confirm(`–ê—Ä—Ç "${sku}"?\n–°—Ç–≤–æ—Ä–∏—Ç–∏?`)) {
                    const name = prompt(`–ù–∞–∑–≤–∞ –¥–ª—è "${sku}":`, '');
                    const fName = (name === null || name.trim() === '') ? `–ù–æ–≤–∏–π ${sku}` : name.trim();
                    const newItem = { sku, name: fName, expectedQuantity: 0, actualQuantity: null, status: STATUS_MAP.NONE };
                    try {
                        items.push(newItem); await saveItemToDB(newItem); console.log(`${sku} saved.`);
                        lastDisplayedItem = { ...newItem }; displayItemCard(lastDisplayedItem);
                        if(quantityInput) { quantityInput.disabled = false; quantityInput.value = ''; quantityInput.placeholder = `–ö-—Å—Ç—å ${sku}`; }
                        if(quantitySubmitButton) quantitySubmitButton.disabled = false; // –í–º–∏–∫–∞—î–º–æ –∫–Ω–æ–ø–∫—É
                        console.log("Focusing quantity (new item)"); if(quantityInput) quantityInput.focus(); // –§–æ–∫—É—Å –Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å
                        currentItem = newItem; updateUI(); showToast(`–°—Ç–≤–æ—Ä–µ–Ω–æ:${sku}`, 'success'); vibrateBasic();
                    } catch (err) {
                        console.error(`Save ${sku} err:`, err); showToast(`–ü–æ–º–∏–ª–∫–∞:${err}`, 'error'); items = items.filter(i => i.sku !== sku); updateUI(); if (skuInput) skuInput.focus();
                    }
                } else {
                    console.log("Create cancelled."); if (skuInput) { skuInput.value = ''; skuInput.focus(); }
                }
            } else { // –ü–æ–ª–µ SKU –ø–æ—Ä–æ–∂–Ω—î
                if(quantityInput) quantityInput.disabled = true;
                if(quantitySubmitButton) quantitySubmitButton.disabled = true; // –í–∏–º–∏–∫–∞—î–º–æ –∫–Ω–æ–ø–∫—É –∫-—Å—Ç—ñ
                if(quantityInput) quantityInput.placeholder="–ß–∏—Å–ª–æ(+) –∞–±–æ 0+–ß–∏—Å–ª–æ(-)";
            }
        }
        // –ó–ú–Ü–ù–ï–ù–û: –î–æ–¥–∞–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É event?.type
        function handleQuantityInput(event) {
             // –î–æ–∑–≤–æ–ª—è—î–º–æ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è, —è–∫—â–æ —Ü–µ –Ω–µ keydown, –ê–ë–û —è–∫—â–æ —Ü–µ Enter, –ê–ë–û —è–∫—â–æ event –Ω–µ —ñ—Å–Ω—É—î (–∫–ª—ñ–∫ –∫–Ω–æ–ø–∫–∏)
            if (event?.type === 'keydown' && event?.key !== 'Enter') { console.log("Ignoring keydown (not Enter)"); return; }
            if (!currentItem) { showToast("–ó–Ω–∞–π–¥—ñ—Ç—å —Ç–æ–≤–∞—Ä.", "warning"); return; }
            const inp = quantityInput?.value?.trim(); if (!inp) return; let newQ; const itemU = { ...currentItem }; const curA = itemU.actualQuantity ?? 0;
            try { if (inp.startsWith('0')) { if (inp.length<=1 || !/^\d+$/.test(inp.substring(1))) { showToast("0+—Ü–∏—Ñ—Ä–∏.", "warning"); if(quantityInput) quantityInput.value=''; return; } const sub=parseInt(inp.substring(1), 10); newQ=Math.max(0, curA-sub); } else { if (!/^\d+$/.test(inp)) { showToast("–ß–∏—Å–ª–æ.", "warning"); if(quantityInput) quantityInput.value=''; return; } const add=parseInt(inp, 10); if (add > 0) { newQ=curA+add; } else { showToast("–î–æ–¥–∞–≤–∞—Ç–∏ > 0.", "warning"); if(quantityInput) quantityInput.value=''; return; } } }
            catch (e) { console.error("Parse err:", e); showToast("–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏.", "error"); if(quantityInput) quantityInput.value=''; return; }
            itemU.actualQuantity = newQ; itemU.status = calculateStatus(itemU.expectedQuantity, itemU.actualQuantity);
            console.log(`Save:${itemU.sku}, Q:${newQ}`);
            saveItemToDB(itemU).then(() => { const i = items.findIndex(it => it.sku === itemU.sku); if (i !== -1) items[i] = itemU; else console.error(`Idx ${itemU.sku}!`); lastDisplayedItem = { ...itemU }; updateUI(); showToast(`–ö-—Å—Ç—å ${itemU.sku} –æ–Ω–æ–≤–ª–µ–Ω–æ.`, 'success', 2000); vibrateBasic(); clearInputs(); if (skuInput) skuInput.focus(); }).catch(err => { console.error("Save err:", err); showToast(`–ü–æ–º–∏–ª–∫–∞:${err}`, 'error'); if (quantityInput) quantityInput.focus(); });
        }
        function calculateStatus(expected, actual) { if(actual==null)return STATUS_MAP.NONE;const nE=Number(expected);const nA=Number(actual);if(isNaN(nE)||isNaN(nA))return STATUS_MAP.NONE;if(nA===nE)return STATUS_MAP.MATCH;else if(nA<nE)return STATUS_MAP.SHORTAGE;else return STATUS_MAP.SURPLUS; }

        // --- –û–Ω–æ–≤–ª–µ–Ω–Ω—è UI ---
        function updateUI() { try{if(progressSection)updateProgressAndStats();if(itemsTableBody)renderTable();if(resultsTableBody)renderResultsTable();updateControlStates();updateFileInfo();if(lastDisplayedItem&&itemCard)displayItemCard(lastDisplayedItem);else if(itemCard)clearItemCard();}catch(e){console.error("UpdateUI err:",e);} }
        // –ó–ú–Ü–ù–ï–ù–û: renderTable —Ç–µ–ø–µ—Ä —Ñ—ñ–ª—å—Ç—Ä—É—î —ñ –∑–∞ –Ω–∞–∑–≤–æ—é
        function renderTable() { if(!itemsTableBody)return;itemsTableBody.innerHTML='';if(items.length===0){itemsTableBody.innerHTML='<tr class="empty-msg"><td colspan="5">–ü—É—Å—Ç–æ.</td></tr>';return;}const nameSearch=nameSearchInput?.value?.trim().toLowerCase()||'';let statusFiltered=items.filter(i=>currentFilter==='all'||i.status===STATUS_MAP[currentFilter.toUpperCase()]||(currentFilter==='unchecked'&&i.status===STATUS_MAP.NONE));const finalFiltered=nameSearch?statusFiltered.filter(i=>i.name.toLowerCase().includes(nameSearch)):statusFiltered;if(finalFiltered.length===0){let msg=`–§—ñ–ª—å—Ç—Ä:"${filterSelect?.options[filterSelect.selectedIndex]?.text||currentFilter}"`;if(nameSearch){msg+=`|–ü–æ—à—É–∫:"${nameSearch}"`;}msg+=": –Ω–µ–º–∞—î.";itemsTableBody.innerHTML=`<tr class="empty-msg"><td colspan="5">${msg}</td></tr>`;return;}const frag=document.createDocumentFragment();finalFiltered.forEach(i=>frag.appendChild(createRowElement(i)));itemsTableBody.appendChild(frag);}
        function renderResultsTable() { if(!resultsTableBody)return;resultsTableBody.innerHTML='';const disc=items.filter(i=>i.status===STATUS_MAP.SHORTAGE||i.status===STATUS_MAP.SURPLUS);disc.sort((a,b)=>{const o={[STATUS_MAP.SHORTAGE]:1,[STATUS_MAP.SURPLUS]:2};return o[a.status]-o[b.status]||String(a.sku).localeCompare(String(b.sku))});if(disc.length===0){resultsTableBody.innerHTML='<tr class="empty-msg"><td colspan="6">–†–æ–∑–±—ñ–∂–Ω–æ—Å—Ç–µ–π –Ω–µ–º–∞—î.</td></tr>';return;}const frag=document.createDocumentFragment();disc.forEach(i=>frag.appendChild(createRowElement(i,true)));resultsTableBody.appendChild(frag);}
        function createRowElement(item, includeDifference=false) { const r=document.createElement('tr');r.dataset.sku=item.sku;const sCls=STATUS_CLASS_MAP[item.status]||STATUS_CLASS_MAP.NONE;r.className=sCls;r.addEventListener('click',()=>handleTableRowClick(item.sku));let pT;const cLP=()=>clearTimeout(pT);r.addEventListener('touchstart',(e)=>{clearTimeout(pT);pT=window.setTimeout(()=>{handleTableRowLongPress(item.sku);},700);},{passive:false});r.addEventListener('touchend',cLP);r.addEventListener('touchmove',cLP);r.addEventListener('touchcancel',cLP);r.addEventListener('contextmenu',(e)=>{e.preventDefault();handleTableRowLongPress(item.sku);});const sTxt=item.status||STATUS_MAP.NONE;const aQty=item.actualQuantity!==null?item.actualQuantity:'-';const sTxtCls=STATUS_TEXT_CLASS_MAP[sTxt]||'';const sC=document.createElement('td');sC.innerHTML=`<span class="status-indicator"></span><span class="${sTxtCls}">${sTxt}</span>`;const skuC=document.createElement('td');skuC.textContent=item.sku;const nmC=document.createElement('td');nmC.textContent=item.name;const exC=document.createElement('td');exC.textContent=item.expectedQuantity;const acC=document.createElement('td');acC.textContent=aQty;r.appendChild(sC);r.appendChild(skuC);r.appendChild(nmC);r.appendChild(exC);r.appendChild(acC);if(includeDifference){let diff='-',dTxt='-',dCls='';if(item.actualQuantity!==null&&typeof item.expectedQuantity==='number'){diff=item.actualQuantity-item.expectedQuantity;dTxt=(diff>0?'+':'')+diff;dCls=diff>0?'status-text-surplus':(diff<0?'status-text-shortage':'');}const dC=document.createElement('td');dC.textContent=dTxt;dC.className=dCls;r.appendChild(dC);} return r;}
        function handleTableRowClick(sku) { if(sku==null)return;switchToTab('inventory-tab');if(skuInput)skuInput.value=sku;handleSkuInput();vibrateBasic();}
        function handleTableRowLongPress(sku) { if(sku==null)return;showToast(`–ù–∞—Ç–∏—Å–∫:${sku}`,'info',1500);vibrateNotification();if(currentItem?.sku===sku&&quantityInput){quantityInput.focus();quantityInput.select();}else{handleTableRowClick(sku);}}
        function displayItemCard(item) { if(!itemCard||!item){clearItemCard();return;}if(itemNameEl)itemNameEl.textContent=item.name??'-';if(itemSkuEl)itemSkuEl.textContent=item.sku??'-';if(itemExpectedEl)itemExpectedEl.textContent=item.expectedQuantity??'-';if(itemActualEl)itemActualEl.textContent=item.actualQuantity!==null?item.actualQuantity:'-';const sTxt=item.status||STATUS_MAP.NONE;if(itemStatusEl){itemStatusEl.textContent=sTxt;itemStatusEl.className=STATUS_TEXT_CLASS_MAP[sTxt]||'';}itemCard.className='';const sCls=STATUS_CLASS_MAP[sTxt]||STATUS_CLASS_MAP.NONE;itemCard.classList.add(sCls);itemCard.classList.add('visible');}
        function clearItemCard() { if(itemCard)itemCard.classList.remove('visible');}
        function calculateStats() { const t=items.length;let c=0,m=0,s=0,p=0;items.forEach(i=>{if(i.status!==STATUS_MAP.NONE){c++;if(i.status===STATUS_MAP.MATCH)m++;else if(i.status===STATUS_MAP.SHORTAGE)s++;else if(i.status===STATUS_MAP.SURPLUS)p++;}});return{total:t,checked:c,match:m,shortage:s,surplus:p};}
        function updateProgressAndStats() { if(!progressBar||!progressSection||!items)return;const sTV=document.getElementById('stat-total')?.querySelector('.stat-value');const sCV=document.getElementById('stat-checked')?.querySelector('.stat-value');const sMV=document.getElementById('stat-match')?.querySelector('.stat-value');const sSV=document.getElementById('stat-shortage')?.querySelector('.stat-value');const sPV=document.getElementById('stat-surplus')?.querySelector('.stat-value');if(items.length===0){progressBar.style.width='0%';if(sTV)sTV.textContent='0';if(sCV)sCV.textContent='0';if(sMV)sMV.textContent='0';if(sSV)sSV.textContent='0';if(sPV)sPV.textContent='0';progressSection.classList.remove('visible');return;}progressSection.classList.add('visible');const st=calculateStats();const prg=st.total>0?Math.round((st.checked/st.total)*100):0;progressBar.style.width=`${prg}%`;if(sTV)sTV.textContent=st.total;if(sCV)sCV.textContent=st.checked;if(sMV)sMV.textContent=st.match;if(sSV)sSV.textContent=st.shortage;if(sPV)sPV.textContent=st.surplus;}

        // –ó–º—ñ–Ω–µ–Ω–æ: –ü–µ—Ä–µ–π–º–µ–Ω–æ–≤–∞–Ω–∞ + –ª–æ–≥—ñ–∫–∞ –¥–ª—è –∫–Ω–æ–ø–æ–∫/–ø–æ—à—É–∫—É
        function updateControlStates() {
            const hasItems = items.length > 0;
            if(saveButton) saveButton.disabled = !hasItems;
            if(clearButton) clearButton.disabled = !hasItems;
            if(filterSelect) { filterSelect.disabled = !hasItems; filterSelect.value = currentFilter; }
            if(nameSearchInput) { nameSearchInput.disabled = !hasItems; }
            // –ö–Ω–æ–ø–∫–∏ –±—ñ–ª—è —ñ–Ω–ø—É—Ç—ñ–≤ - —ó—Ö —Å—Ç–∞–Ω –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ —Å—Ç–∞–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ–≥–æ —ñ–Ω–ø—É—Ç—É
            if(skuSubmitButton) skuSubmitButton.disabled = skuInput?.disabled; // –ö–Ω–æ–ø–∫–∞ SKU –∞–∫—Ç–∏–≤–Ω–∞ –∑–∞–≤–∂–¥–∏, –∫–æ–ª–∏ –∞–∫—Ç–∏–≤–Ω–µ –ø–æ–ª–µ SKU (–∑–∞–∑–≤–∏—á–∞–π –∑–∞–≤–∂–¥–∏)
            if(quantitySubmitButton) quantitySubmitButton.disabled = quantityInput?.disabled; // –ö–Ω–æ–ø–∫–∞ –ö-—Å—Ç—ñ –∞–∫—Ç–∏–≤–Ω–∞, –∫–æ–ª–∏ –∞–∫—Ç–∏–≤–Ω–µ –ø–æ–ª–µ –ö-—Å—Ç—ñ
            updateSelectArrowColor();
        }

        function updateFileInfo() { if(!fileInfoEl)return;if(fileMetadata.originalName){const dS=fileMetadata.loadDate?`–∑–∞–≤:${fileMetadata.loadDate.toLocaleString('uk',{dateStyle:'short',timeStyle:'short'})}`:'';fileInfoEl.textContent=`–§–∞–π–ª:${fileMetadata.originalName} (${dS})`;}else{fileInfoEl.textContent='–§–∞–π–ª –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ.';} }
        function handleFilterChange() { if(!filterSelect)return;currentFilter=filterSelect.value;renderTable();vibrateBasic(); }
        function handleNameSearchInput() { renderTable(); } // –ü—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–º–∞–ª—å–æ–≤—É—î–º–æ —Ç–∞–±–ª–∏—Ü—é

        function switchToTab(tabId) { if(!tabId)return;tabContents.forEach(c=>c?.classList.remove('active'));document.getElementById(tabId)?.classList.add('active');tabButtons.forEach(b=>{b?.classList.toggle('active',b.dataset.tab===tabId);});if(tabId==='items-tab')renderTable();else if(tabId==='result-tab')renderResultsTable();vibrateBasic();}

        // --- –û—á–∏—â–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö ---
        function clearAllData(confirmFirst = true) { const doClear=()=>{items=[];fileMetadata={originalName:null,loadDate:null};currentItem=null;lastDisplayedItem=null;currentFilter='all';Promise.all([clearItemsDB(),clearMetadataDB()]).then(()=>{console.log("–ë–î –æ—á–∏—â–µ–Ω–æ.");clearInputs();updateUI();showToast("–î–∞–Ω—ñ –æ—á–∏—â–µ–Ω–æ.");vibrateNotification();switchToTab('inventory-tab');if(skuInput)skuInput.focus();}).catch(err=>{console.error("–ü–æ–º–∏–ª–∫–∞:",err);showToast(`–ü–æ–º–∏–ª–∫–∞:${err}`,'error');clearInputs();updateUI();});};if(confirmFirst){if(confirm('–û—á–∏—Å—Ç–∏—Ç–∏ –¥–∞–Ω—ñ?'))doClear();}else{doClear();} }
        // –ó–º—ñ–Ω–µ–Ω–æ: clearInputs —Ç–µ–ø–µ—Ä –≤–∏–º–∏–∫–∞—î —ñ –∫–Ω–æ–ø–∫—É –∫-—Å—Ç—ñ
         function clearInputs() {
            if(skuInput) skuInput.value = '';
            if(quantityInput) { quantityInput.value = ''; quantityInput.disabled = true; quantityInput.placeholder = "–ß–∏—Å–ª–æ(+) –∞–±–æ 0+–ß–∏—Å–ª–æ(-)"; }
            if(quantitySubmitButton) quantitySubmitButton.disabled = true; // –í–∏–º–∏–∫–∞—î–º–æ –∫–Ω–æ–ø–∫—É
            if(fileInput) fileInput.value = '';
            if(nameSearchInput) nameSearchInput.value = '';
            currentItem = null;
         }

        // --- –î–æ–ø–æ–º—ñ–∂–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó UX ---
        let toastTimeout; function showToast(m,t='info',d=3000){if(!toastNotification)return;if(toastTimeout)clearTimeout(toastTimeout);toastNotification.textContent=m;toastNotification.className='show';let bg;const isDark=document.body.classList.contains('dark-theme');switch(t){case'success':bg=isDark?'rgba(48,209,88,0.9)':'rgba(40,167,69,0.9)';break;case'warning':bg=isDark?'rgba(255,159,10,0.9)':'rgba(255,193,7,0.9)';break;case'error':bg=isDark?'rgba(255,69,58,0.9)':'rgba(220,53,69,0.9)';break;default:bg=isDark?'rgba(230,230,230,0.85)':'rgba(50,50,50,0.9)';break;}toastNotification.style.backgroundColor=bg;toastNotification.style.color=t==='info'&&isDark?'#1c1c1e':'#ffffff';toastTimeout=setTimeout(()=>{toastNotification.classList.remove('show');setTimeout(()=>{if(toastNotification)toastNotification.style.backgroundColor='';},300);},d);}
        function vibrateBasic() { try{if(navigator.vibrate)navigator.vibrate(30);}catch(e){} }
        function vibrateNotification() { try{if(navigator.vibrate)navigator.vibrate([80,40,80]);}catch(e){} }
        function handleOutsideClick(event){const aE=document.activeElement;const iA=aE instanceof HTMLElement&&(aE.tagName==='INPUT'||aE.tagName==='TEXTAREA');const t=event.target;const iO=t instanceof Node&&!t.closest('input,textarea,button,label,select,option,[role="button"],[role="tab"],a[href],details,summary');if(iA&&iO)aE.blur();}

        // --- –§—É–Ω–∫—Ü—ñ—ó —Ç–µ–º–∏ ---
        function setTheme(themeName) { try { const isDark=themeName==='dark'; document.body.classList.toggle('dark-theme',isDark); if (themeToggleButton) { const sun=themeToggleButton.querySelector('.theme-icon-sun'); const moon=themeToggleButton.querySelector('.theme-icon-moon'); if(sun)sun.style.display=isDark?'block':'none'; if(moon)moon.style.display=isDark?'none':'block'; themeToggleButton.setAttribute('aria-label', isDark ? '–°–≤—ñ—Ç–ª–∞ —Ç–µ–º–∞' : '–¢–µ–º–Ω–∞ —Ç–µ–º–∞'); } localStorage.setItem('theme', isDark ? 'dark' : 'light'); /* console.log(`–¢–µ–º–∞:${isDark?'—Ç–µ–º–Ω–∞':'—Å–≤—ñ—Ç–ª–∞'}`); */ updateSelectArrowColor(); }catch(e){console.error("SetTheme Err:",e);} }
        function toggleTheme() { try {const current=localStorage.getItem('theme'); setTheme(current==='dark'?'light':'dark'); vibrateBasic();}catch(e){console.error("ToggleTheme Err:",e);} }
        function updateSelectArrowColor() { if (!filterSelect) return; try { const mutedColor = getComputedStyle(document.body).getPropertyValue('--secondary-text-color').trim(); const disabledColor = getComputedStyle(document.body).getPropertyValue('--separator-color').trim(); const encodedMuted = encodeURIComponent(mutedColor.startsWith('#') ? mutedColor.substring(1) : mutedColor); const encodedDisabled = encodeURIComponent(disabledColor.startsWith('#') ? disabledColor.substring(1) : disabledColor); const enabledSvg = `url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22%23${encodedMuted}%22%3E%3Cpath%20fill-rule%3D%22evenodd%22%20d%3D%22M4.22%206.22a.75.75%200%20011.06%200L8%208.94l2.72-2.72a.75.75%200%20111.06%201.06l-3.25%203.25a.75.75%200%2001-1.06%200L4.22%207.28a.75.75%200%20010-1.06z%22%20clip-rule%3D%22evenodd%22%20%2F%3E%3C%2Fsvg%3E')`; const disabledSvg = `url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22%23${encodedDisabled}%22%3E%3Cpath%20fill-rule%3D%22evenodd%22%20d%3D%22M4.22%206.22a.75.75%200%20011.06%200L8%208.94l2.72-2.72a.75.75%200%20111.06%201.06l-3.25%203.25a.75.75%200%2001-1.06%200L4.22%207.28a.75.75%200%20010-1.06z%22%20clip-rule%3D%22evenodd%22%20%2F%3E%3C%2Fsvg%3E')`; filterSelect.style.backgroundImage = filterSelect.disabled ? disabledSvg : enabledSvg; } catch (e) { console.warn("Update arrow err:", e); } }

        // --- –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –¥–æ–¥–∞—Ç–∫—É ---
        async function initializeApp() {
             console.log("–Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è v1.3.6..."); // –û–Ω–æ–≤–ª–µ–Ω–æ –≤–µ—Ä—Å—ñ—é
             // 1. –¢–µ–º–∞
             try{const sT=localStorage.getItem('theme');if(sT)setTheme(sT);else{if(window.matchMedia?.('(prefers-color-scheme:dark)')?.matches)setTheme('dark');else setTheme('light');}}catch(e){console.error("–¢–µ–º–∞ Err:",e)}
             // 2. –ë–î —Ç–∞ –¥–∞–Ω—ñ
             try { console.log("–ë–î..."); await openDB(); console.log("–ë–î Ok."); let lI=null,lM=null; try{[lI,lM]=await Promise.all([getAllItemsFromDB(),getMetadataFromDB()]);console.log("–î–∞–Ω—ñ –∑ –ë–î Ok.");}catch(e){console.error("–î–∞–Ω—ñ Err:",e);items=[];fileMetadata={originalName:null,loadDate:null};} if(lI?.length>0){items=lI;fileMetadata=lM||{originalName:null,loadDate:null};console.log(`–í—ñ–¥–Ω–æ–≤–ª–µ–Ω–æ:${items.length}.`);showToast("–°–µ—Å—ñ—é –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–æ.","success",2000);}else{console.log("–î–∞–Ω—ñ –≤—ñ–¥—Å—É—Ç–Ω—ñ.");items=[];fileMetadata={originalName:null,loadDate:null};} lastDisplayedItem=null; console.log("UI...");updateUI(); console.log("UI Ok.");
             } catch (e) { console.error("Init DB Err:",e);showToast(`Init DB Err:${e.message||e}`,'error',5000);items=[];fileMetadata={originalName:null,loadDate:null};lastDisplayedItem=null;try{updateUI();}catch(e2){} }
             // 3. UI —Ç–∞ –û–±—Ä–æ–±–Ω–∏–∫–∏
             try { console.log("UI Cfg...");clearInputs();updateControlStates();switchToTab('inventory-tab'); console.log("Listeners...");
                 fileInput?.addEventListener('change',handleFile);
                 uploadButton?.addEventListener('click',()=>{ fileInput?.click(); });
                 skuInput?.addEventListener('change',handleSkuInput);
                 quantityInput?.addEventListener('change',handleQuantityInput);
                 quantityInput?.addEventListener('keydown',handleQuantityInput);
                 saveButton?.addEventListener('click',()=>{saveResultsToFile();vibrateBasic();});
                 clearButton?.addEventListener('click',()=>{clearAllData(true);});
                 filterSelect?.addEventListener('change',handleFilterChange);
                 nameSearchInput?.addEventListener('input', handleNameSearchInput);
                 // –î–û–î–ê–ù–û: –°–ª—É—Ö–∞—á—ñ –¥–ª—è –Ω–æ–≤–∏—Ö –∫–Ω–æ–ø–æ–∫
                 skuSubmitButton?.addEventListener('click', handleSkuInput);
                 quantitySubmitButton?.addEventListener('click', () => handleQuantityInput(null)); // –ü–µ—Ä–µ–¥–∞—î–º–æ null –∑–∞–º—ñ—Å—Ç—å event

                 tabButtons.forEach(b=>{b?.addEventListener('click',()=>switchToTab(b.dataset.tab));});
                 themeToggleButton?.addEventListener('click',toggleTheme);
                 document.addEventListener('click',handleOutsideClick);
                 console.log("   - Listeners Ok."); console.log("–§–æ–∫—É—Å...");skuInput?.focus();console.log("–§–æ–∫—É—Å Ok.");
                 console.log("===== INIT v1.3.6 DONE ====="); // –û–Ω–æ–≤–ª–µ–Ω–æ –≤–µ—Ä—Å—ñ—é
             } catch (e) { console.error("Init UI Err:",e);showToast(`UI Init Err:${e.message||e}`,'error',5000); }
             updateSelectArrowColor();
        }

        // –ó–∞–ø—É—Å–∫
        document.addEventListener('DOMContentLoaded', initializeApp);

    </script>
</body>
</html>
